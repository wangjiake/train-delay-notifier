# ============================================
# é›»è»Šé…å»¶ãƒã‚§ãƒƒã‚«ãƒ¼ - GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ¯Žæ—¥08:00ã¨18:20 JST ã«å®Ÿè¡Œ
# ============================================

name: ðŸšƒ Train Delay Checker

on:
  # å®šæ™‚å®Ÿè¡Œï¼ˆUTCæ™‚é–“ã§æŒ‡å®šï¼‰
  schedule:
    - cron: '0 23 * * *'   # æ¯Žæ—¥ 08:00 JST (= 23:00 UTC å‰æ—¥)
    - cron: '20 9 * * *'   # æ¯Žæ—¥ 18:20 JST (= 09:20 UTC)
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_email:
        description: 'é…å»¶ãŒãªãã¦ã‚‚ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹'
        required: false
        type: boolean
        default: false

jobs:
  check-delays:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Build TypeScript
        run: npm run build
      
      - name: ðŸšƒ Check train delays
        env:
          # GitHub Secrets ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FORCE_EMAIL: ${{ github.event.inputs.force_email }}
        run: npm start
      
      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸšƒ é›»è»Šé…å»¶ãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›£è¦–è·¯ç·š**: æ—¥æ¯”è°·ç·šã€äº¬è‘‰ç·š" >> $GITHUB_STEP_SUMMARY
